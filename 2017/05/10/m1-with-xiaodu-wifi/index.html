<html>
<head>
	
	<title>在NanoPi M1下使用小度Wi-Fi</title>
	<meta name="keywords" content="My Blog, Spider Bitch!" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<h1 id="logo">在NanoPi M1下使用小度Wi-Fi</h1>
<p>M1的固件nanopi-m1-debian-sd4g-20160907.img.zip已经自带了小度Wi-Fi的驱动——mt7601u，但是没法即插即用，不知道为什么。为了使用小度Wi-Fi需要进行一些设置。</p>
<p>因为大多数讲Wi-Fi的文章都只是列了一下配置，然后就OK，但是自己不成功的话，无从排查问题。本文尝试引入几个命令来帮助排查问题，虽然我也是对整个配置过程一知半解，但了解了这几个命令还是有很大帮助。</p>
<h2 id="1-lsusb"><a href="#1-lsusb" class="headerlink" title="1. lsusb"></a>1. lsusb</h2><p>插上小度Wi-Fi，我们首先需要确认是不是被系统识别了，那就需要用<code>lsusb</code>，首先用如下命令安装<code>lsusb</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install usbutils</div></pre></td></tr></table></figure>
<p>然后执行<code>lsusb</code>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Bus 008 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub</div><div class="line">Bus 007 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub</div><div class="line">Bus 006 Device 002: ID 2955:1001  </div><div class="line">Bus 006 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub</div><div class="line">Bus 005 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub</div></pre></td></tr></table></figure>
<p>如果有2955:1001，则表示小度Wi-Fi被识别了，对于其他的设备，可以通过该命令在查看设备的Device ID。</p>
<h2 id="2-dmesg"><a href="#2-dmesg" class="headerlink" title="2. dmesg"></a>2. dmesg</h2><p>dmesg可以用来查看内核输出的信息，我们用它来查看驱动是否加载了。插上小度Wi-Fi后，在终端中执行<code>dmesg</code>命令，如果驱动加载正常在最后会有如下输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[  142.050149] usb 2-1: new high-speed USB device number 2 using sunxi-ehci</div><div class="line">[  141.449845] cfg80211: World regulatory domain updated:</div><div class="line">[  141.455614] cfg80211:  DFS Master region: unset</div><div class="line">[  141.460469] cfg80211:   (start_freq - end_freq @ bandwidth), (max_antenna_gain, max_eirp), (dfs_cac_time)</div><div class="line">[  141.471300] cfg80211:   (2402000 KHz - 2472000 KHz @ 40000 KHz), (N/A, 2000 mBm), (N/A)</div><div class="line">[  141.480206] cfg80211:   (2457000 KHz - 2482000 KHz @ 40000 KHz), (N/A, 2000 mBm), (N/A)</div><div class="line">[  141.489085] cfg80211:   (2474000 KHz - 2494000 KHz @ 20000 KHz), (N/A, 2000 mBm), (N/A)</div><div class="line">[  141.498000] cfg80211:   (5170000 KHz - 5250000 KHz @ 80000 KHz, 160000 KHz AUTO), (N/A, 2000 mBm), (N/A)</div><div class="line">[  141.508545] cfg80211:   (5250000 KHz - 5330000 KHz @ 80000 KHz, 160000 KHz AUTO), (N/A, 2000 mBm), (0 s)</div><div class="line">[  141.519081] cfg80211:   (5490000 KHz - 5730000 KHz @ 160000 KHz), (N/A, 2000 mBm), (0 s)</div><div class="line">[  141.528078] cfg80211:   (5735000 KHz - 5835000 KHz @ 80000 KHz), (N/A, 2000 mBm), (N/A)</div><div class="line">[  141.530052] usb 2-1: reset high-speed USB device number 2 using sunxi-ehci</div><div class="line">[  141.544599] cfg80211:   (57240000 KHz - 63720000 KHz @ 2160000 KHz), (N/A, 0 mBm), (N/A)</div><div class="line">[  141.683042] mt7601u 2-1:1.0: ASIC revision: 76010001 MAC revision: 76010500</div><div class="line">[  141.699552] mt7601u 2-1:1.0: Firmware Version: 0.1.00 Build: 7640 Build time: 201302052146____</div><div class="line">[  142.113339] mt7601u 2-1:1.0: Warning: unsupported EEPROM version 0d</div><div class="line">[  142.120500] mt7601u 2-1:1.0: EEPROM ver:0d fae:00</div><div class="line">[  142.126447] mt7601u 2-1:1.0: EEPROM country region 01 (channels 1-13)</div><div class="line">[  142.372181] ieee80211 phy0: Selected rate control algorithm &apos;minstrel_ht&apos;</div><div class="line">[  142.374575] usbcore: registered new interface driver mt7601u</div></pre></td></tr></table></figure>
<p>也可以使用<code>dmesg | grep mt7601</code>来精简输出：</p>
<p>​    [   10.030133] mt7601u 6-1:1.0: ASIC revision: 76010001 MAC revision: 76010500<br>​    [   10.495110] mt7601u 6-1:1.0: Warning: unsupported EEPROM version 0d<br>​    [   10.507867] mt7601u 6-1:1.0: EEPROM ver:0d fae:00<br>​    [   10.527104] mt7601u 6-1:1.0: EEPROM country region 01 (channels 1-13)<br>​    [   11.465717] usbcore: registered new interface driver mt7601u</p>
<p>只要看到<code>usbcore: registered new interface driver mt7601u</code>就表示小度Wi-Fi已经被识别出来了并且加载了。</p>
<h2 id="3-lsmod-和-modinfo"><a href="#3-lsmod-和-modinfo" class="headerlink" title="3. lsmod 和 modinfo"></a>3. lsmod 和 modinfo</h2><p>假入没有类似输出，我们可能要进一步确认mt7601u是不是加载了，那就需要用<code>lsmod</code>，正常来说会输出如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Module                  Size  Used by</div><div class="line">mt7601u                73012  0 </div><div class="line">mac80211              495881  1 mt7601u</div><div class="line">cfg80211              470289  2 mac80211,mt7601u</div><div class="line">mali_drm                5741  1 </div><div class="line">mali                  194124  0 </div><div class="line">ump                    37786  3 mali</div><div class="line">rfcomm                 21114  4 </div><div class="line">bnep                    9149  2 </div><div class="line">hci_uart               11776  0 </div><div class="line">btbcm                   5304  1 hci_uart</div><div class="line">bluetooth             300113  10 bnep,btbcm,hci_uart,rfcomm</div><div class="line">compat                 25372  7 bnep,cfg80211,mac80211,mt7601u,hci_uart,rfcomm,bluetooth</div></pre></td></tr></table></figure>
<p>可以看到mt7601已经加载了，但是没用啊。我们在用<code>sudo modinfo mt7601u</code>来查看驱动的具体信息，正常输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">filename:       /lib/modules/3.4.39-h3/updates/drivers/net/wireless/mediatek/mt7601u/mt7601u.ko</div><div class="line">version:        backported from Linux (v4.4.2-0-g1cb8570) using backports v4.4.2-1-0-gbec4037</div><div class="line">license:        GPL</div><div class="line">firmware:       mt7601u.bin</div><div class="line">srcversion:     06486A44A19698210D54450</div><div class="line">alias:          usb:v7392p7710d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v2A5Fp1000d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v2955p1001d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v2955p0001d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v2717p4106d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v2001p3D04d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v148Fp760Dd*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v148Fp760Cd*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v148Fp760Bd*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v148Fp760Ad*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v148Fp7601d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v13D3p3434d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v13D3p3431d*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v0E8Dp760Bd*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v0E8Dp760Ad*dc*dsc*dp*ic*isc*ip*</div><div class="line">alias:          usb:v0B05p17D3d*dc*dsc*dp*ic*isc*ip*</div><div class="line">depends:        mac80211,compat,cfg80211</div><div class="line">vermagic:       3.4.39-h3 SMP preempt mod_unload ARMv7 p2v8</div></pre></td></tr></table></figure>
<p>注意其中的alias，其中的<code>usb:vXXXXpXXXd</code>这部分实际上对应的是USB设备的deviceID，所以需要看一下有没有小度Wi-Fi的ID：2955:1001，如果没有，那么你需要自己编译mt7601来支持了，M1自带的是支持小度Wi-Fi的。所以一切正常的话，完全可以驱动起来。对于其他Wi-Fi设备，可以通过lsusb来获取DeviceID来查看驱动是否支持。</p>
<h2 id="4-ip-addr"><a href="#4-ip-addr" class="headerlink" title="4. ip addr"></a>4. ip addr</h2><p>虽然mt7601支持小度Wi-Fi，内核也提示已经创建了接口，但是通过<code>sudo ifconfig</code>还是看不到wlan0。这时我们需要用<code>sudo ip addr</code>来确认是不是已经创建wlan0了还是有其他的网络接口（实际官方的mt7601驱动创建的是ra0网络接口），假设你使用过其他Wi-Fi设备，此时为小度创建的接口可能是wlan1，这个需要确认一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">7: wlan0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</div><div class="line">    link/ether xx:xx:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff</div></pre></td></tr></table></figure>
<p>可以根据link/ether后的Mac地址：xx:xx:xx:xx:xx:xx来确认哪个接口是小度Wi-Fi。</p>
<p>如果这里没有小度Wi-Fi输出的话，说明驱动还是有问题，但是我也不知道该从哪里去查了。</p>
<h2 id="5-配置小度Wi-Fi"><a href="#5-配置小度Wi-Fi" class="headerlink" title="5. 配置小度Wi-Fi"></a>5. 配置小度Wi-Fi</h2><p>到此为止，我们基本就可以定位小度Wi-Fi的驱动问题了。下一步就是配置来启用小度Wi-Fi。</p>
<h3 id="5-1-启用wlan0"><a href="#5-1-启用wlan0" class="headerlink" title="5.1 启用wlan0"></a>5.1 启用wlan0</h3><p>这里我们需要根据ip addr的输出来确认是wlanX。编辑<code>/etc/network/interfaces</code>文件，增加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">auto wlan0</div><div class="line">allow-hotplug wlan0</div><div class="line">iface wlan0 inet dhcp</div></pre></td></tr></table></figure>
<p>重启系统或者使用<code>sudo /etc/init.d/networking restart</code>来重启网络。</p>
<p>这时使用<code>sudo ifconfig</code>应该可以看到wlan0了。</p>
<h3 id="5-2-连接无线网络"><a href="#5-2-连接无线网络" class="headerlink" title="5.2 连接无线网络"></a>5.2 连接无线网络</h3><p>编辑<code>/etc/wpa_supplicant/wpa_supplicant.conf</code>文件增加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ctrl_interface=/var/run/wpa_supplicant</div><div class="line">network=&#123;</div><div class="line">	ssid=&quot;XXXXXX&quot;</div><div class="line">	psk=&quot;YYYYYY&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中是<code>XXXXXX</code>你要连的无线网络名称，<code>YYYYYY</code>是网络的密码。</p>
<p>然后执行如下命令来连接网络：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo wpa_supplicant -B -iwlan0 /etc/wpa_supplicant/wpa_supplicant.conf</div></pre></td></tr></table></figure>
<p>此时，应该还是没有网络，需要使用如下命令来开关一下wlan0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo ifdown wlan0 # 关闭wlan0</div><div class="line">sudo ifup wlan0   # 启用wlan0</div><div class="line">sudo ifconfig     # 应该可以看到wlan0已经获取IP了</div></pre></td></tr></table></figure>
<h3 id="5-3-开机连接Wi-Fi"><a href="#5-3-开机连接Wi-Fi" class="headerlink" title="5.3 开机连接Wi-Fi"></a>5.3 开机连接Wi-Fi</h3><p>如果想要开机时自动连接Wi-Fi，需要编辑<code>/etc/network/interfaces</code>文件，在5.1中增加的内容之后加入如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pre-up /sbin/wpa_supplicant -B -iwlan0 -c/etc/wpa_supplicant/wpa_supplicant.conf  </div><div class="line">post-down killall -q wpa_supplicant</div></pre></td></tr></table></figure>
<p>至此，小度Wi-Fi就完全配置完成了。</p>
<p>最后啰嗦两句，从树莓派2代开始，就一直想要用上小度Wi-Fi，但一直以来都是以失败告终，几乎无从查找原因。这次又有时间折腾，先是编译了M1的内核，接着又自己编译了mt7601的驱动，其中经历又颇为曲折，但是总算是理清了大致的脉络，然后发现M1是默认支持小度的，但是却没有详细的设置教程，而且debian桌面上的wicd也是无法识别，所以又各种搜索，总算是驱动起来了，心中甚是畅快。但回顾起来又不免感慨，正所谓授人以鱼不如授人以渔，能搜的帖子大多都是“鱼”，单单是4中讲到的确认接口的问题估计就会让好多人无法设置成功，因为很可能是wlan1而不是wlan0。虽然本文远未到“授人以渔”的程度，但多少提供了一些命令来排查各个环节，尽管是以M1为基础环境，但在树莓派、香蕉派等上仍适用。希望各位能用好自己手中的小度Wi-Fi、米Wi-Fi和360Wi-Fi等。</p>










</body>
</html>